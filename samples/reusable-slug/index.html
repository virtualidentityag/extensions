<!doctype html>
<head>
  <link href="https://static.contentful.com/app/main-62e0abc7.css" media="all" rel="stylesheet" type="text/css">
  <link href="https://static.contentful.com/app/vendor-976872d7.css" media="all" rel="stylesheet" type="text/css">
  <link href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css" media="all" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
</head>
<div class="widget-slug-editor">
  <input id="slug" type="text" class="form-control" style="width: 98%; font-size: 14px">
  <i id="loading" class="fa fa-spinner fa-spin"></i>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/3.0.2/es6-promise.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/speakingurl/7.0.0/speakingurl.min.js"></script>

<script>
var cfExt = window.contentfulExtension || window.contentfulWidget

cfExt.init(function (api) {
  var slugField = api.field
  var titleFieldName = api.contentType.displayField
  var titleField = api.entry.fields[titleFieldName]

  var _ = window._
  var getSlug = window.getSlug
  var debouncedUpdateStatus = _.debounce(updateStatus, 500)

  var input = document.getElementById('slug')
  var statusElements = {
    loading: document.getElementById('loading')
  }

  api.window.updateHeight()

  titleField.onValueChanged(handleSlugChange)

  input.addEventListener('input', function () {
    handleSlugChange(input.value)
  })
  input.addEventListener('change', function () {
    handleSlugChange(input.value)
  })

  updateStatus(slugField.getValue())

  /**
   * Handle change of slug value caused by either changing slug field
   * or changing the title of the entry
   */
  function handleSlugChange (value) {
    setSlug(getSlug(value || ''))
  }

  /**
   * Set the input value to 'slug' 
   */
  function setSlug (slug) {
    input.value = slug
    slugField.setValue(slug)
    setStatus('loading')
    debouncedUpdateStatus(slug)
  }

  /**
   * Show icon for given status
   */
  function setStatus (status) {
    _.each(statusElements, function (el, name) {
      if (name === status) {
        el.style.display = 'inline'
      } else {
        el.style.display = 'none'
      }
    })
  }
})
</script>
